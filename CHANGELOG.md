# Changelog

## Unreleased

### Added
- **Fixed-Width Async Stream Writer**: `FixedWidthAsyncStreamWriter` for true non-blocking async I/O
  - `FixedWidth.CreateAsyncStreamWriter(Stream)` - Create a streaming async writer
  - `FixedWidth.CreateStreamWriter(Stream)` - Create a sync writer from a stream
  - `FixedWidth.CreateWriter(TextWriter)` - Alias for `CreateStreamWriter(TextWriter)` to match CSV API
  - Complete API parity between CSV and FixedWidth writer factory methods
- **Fixed-Width File Parsing**: Complete support for fixed-width (fixed-length) file formats
  - `FixedWidth.Read<T>()` - Fluent builder for reading and deserializing records
  - `FixedWidth.Read()` - Non-generic builder for manual row-by-row reading
  - `FixedWidthCharSpanReader` / `FixedWidthByteSpanReader` - Zero-allocation span-based readers
  - `[FixedWidthColumn]` attribute - Map properties to fixed-position fields with Start, Length/End, Alignment, PadChar, Format
  - `End` property as alternative to `Length` - specify field bounds as `Start`/`End` range (e.g., `Start = 0, End = 10`)
  - `FieldAlignment` enum - Left, Right, Center, None alignment modes for proper padding trimming
  - Line-based or fixed-record-length parsing modes
  - Comment lines, empty line skipping, row skipping
  - `AllowShortRows()` - Handle rows shorter than expected gracefully (missing fields return empty values)
  - DoS protection: `MaxRecordCount`, `MaxInputSize` limits
  - Progress reporting with `IProgress<FixedWidthProgress>`
  - Custom type converters via `RegisterConverter<T>()`
  - Null value handling with `WithNullValues()`
- **Fixed-Width File Writing**: Complete support for fixed-width output
  - `FixedWidth.Write<T>()` - Fluent builder for writing typed records
  - `FixedWidth.Write()` - Non-generic builder for manual row-by-row writing
  - `FixedWidth.WriteToText()`, `WriteToFile()`, `WriteToStream()` - Direct writing methods
  - `FixedWidth.WriteToFileAsync()`, `WriteToStreamAsync()` - Async writing with IAsyncEnumerable support
  - `FixedWidthStreamWriter` - Low-level writer for manual field writing
  - Configurable padding, alignment, and newline options
- **Fixed-Width Validation Attributes**: Data validation during deserialization
  - `[FixedWidthRequired]` - Ensure field is not null/empty/whitespace
  - `[FixedWidthStringLength]` - Validate string length with min/max
  - `[FixedWidthRange]` - Validate numeric values within range
  - `[FixedWidthRegex]` - Validate against regular expression pattern
- **Fixed-Width Source Generator**: AOT-compatible record binding
  - `[FixedWidthGenerateBinder]` attribute for compile-time binder generation
  - Reflection-free binding for trimming and AOT scenarios
  - Source-generated alignment enum handling
- **Source Line Number Tracking**: Track physical line numbers in source files for debugging and error reporting
  - `CsvRow.LineNumber` - 1-based logical row number (ordinal position in CSV)
  - `CsvRow.SourceLineNumber` - 1-based physical line number in source file (accounts for multi-line quoted fields)
  - `CsvException.SourceLineNumber` - Physical line number where parse errors occurred
  - Error messages now include both row and line number: "Row 5 (Line 12): ..."
- **High-Performance Async CSV Writer**: `CsvAsyncStreamWriter` for true non-blocking async I/O
  - `Csv.CreateAsyncStreamWriter()` - Create a streaming async writer
  - `Csv.WriteToStreamAsync<T>(stream, IEnumerable<T>)` - Optimized overload for in-memory collections
  - `Csv.WriteToFileAsync<T>(path, IEnumerable<T>)` - Optimized overload for in-memory collections
  - `Csv.WriteToTextAsync<T>(IAsyncEnumerable<T>)` - Write async enumerable sources to a string
  - `ToStreamAsyncStreaming()` builder method with both `IAsyncEnumerable<T>` and `IEnumerable<T>` overloads
  - Sync fast paths for buffer operations - async overhead only when I/O is actually needed
  - `PoolingAsyncValueTaskMethodBuilder` for zero-allocation state machines on .NET 6+
- **Fluent Reader Builder**: `Csv.Read<T>()` fluent API for reading CSV records
  - Symmetric API with `CsvWriterBuilder<T>` for consistent developer experience
  - Configure delimiter, quote character, max columns/rows, and more
  - Terminal methods: `FromText()`, `FromFile()`, `FromStream()`, and async variants
  - All parser and record options accessible through fluent methods
- **Non-Generic Reader Builder**: `Csv.Read()` for manual row-by-row CSV reading
  - Fluent configuration for parser options (delimiter, quote, trimming, etc.)
  - Terminal methods: `FromText()`, `FromFile()`, `FromStream()`, `FromFileAsync()`, `FromStreamAsync()`
- **Fluent Writer Builder**: `Csv.Write<T>()` fluent API for writing CSV records
  - Symmetric API with `CsvReaderBuilder<T>` for consistent developer experience
  - Terminal methods: `ToText()`, `ToFile()`, `ToStream()`, and async variants
  - Configure delimiter, quote style, date/number formats, culture, and more
- **Non-Generic Writer Builder**: `Csv.Write()` for manual row-by-row CSV writing
  - Fluent configuration for writer options (delimiter, quote style, formats)
  - Terminal methods: `CreateWriter()`, `CreateFileWriter()`, `CreateStreamWriter()`
- **CSV Writing**: High-performance CSV writer with RFC 4180 compliance
  - `Csv.WriteToText<T>()` - Write records to a string
  - `Csv.WriteToFile<T>()` / `Csv.WriteToFileAsync<T>()` - Write to files
  - `Csv.WriteToStream<T>()` / `Csv.WriteToStreamAsync<T>()` - Write to streams
  - `Csv.SerializeRecords<T>()` - Symmetric counterpart to `DeserializeRecords<T>()`
  - `CsvStreamWriter` - Low-level writer for row-by-row writing
  - `CsvWriterBuilder` - Fluent API for configuring writers
- **Writer Options**: Full control over CSV output format
  - `QuoteStyle` - Control when fields are quoted (Always, Never, WhenNeeded)
  - `NullValue` - Configure string representation of null values
  - `DateTimeFormat`, `DateOnlyFormat`, `TimeOnlyFormat` - Custom date/time formatting
  - `NumberFormat` - Custom numeric formatting
  - `MaxRowCount` - DoS protection for output
  - `OnSerializeError` - Error handling callback with Skip/WriteNull/Throw options
- **SIMD-Accelerated Writing**: Uses AVX2/SSE2 for single-pass field analysis
- **Source Generator Support**: Compiled expression getters for record serialization
- **LINQ-Style Extension Methods**: Familiar operations for CSV record readers
  - `ToList()`, `ToArray()` - Materialize records into collections
  - `First()`, `FirstOrDefault()`, `Single()`, `SingleOrDefault()` - Element access
  - `Where()`, `Select()` - Filtering and projection
  - `Skip()`, `Take()` - Pagination
  - `Count()`, `Any()`, `All()` - Aggregation
  - `ToDictionary()`, `GroupBy()` - Indexing and grouping
  - `ForEach()` - Iteration
- **Advanced Reader Options**:
  - `WithProgress()` - Progress reporting for large file parsing
  - `OnError()` - Deserialization error handling with Skip/UseDefault/Throw actions
  - `RequireHeaders()` - Enforce required headers
  - `ValidateHeaders()` - Custom header validation callback
  - `DetectDuplicateHeaders()` - Detect duplicate header names
  - `RegisterConverter<T>()` - Custom type converters for domain-specific types
- **AOT Support**: `[CsvGenerateBinder]` attribute for source-generated binders
  - Reflection-free binding for trimming and AOT scenarios
  - Faster startup with pre-compiled binders

### Performance
- **CLMUL-based quote handling**: Uses PCLMULQDQ instruction for branchless prefix XOR computation, enabling ~6% faster parsing than Sep for quoted CSV data
- **Async writing is 16-43% faster than sync** at scale with 25-35% less memory allocation
- CSV writing is 2-5x faster than Sep with 35-85% less memory allocation
- Single-pass field analysis for quote detection and counting
- Direct type handling for common types (int, double, bool, DateTime, etc.) to avoid interface dispatch
- Cached options in hot paths for minimal property access overhead

### Fixed
- **FieldAlignment enum mapping in source generator**: Corrected `FieldAlignment.Center` (value 2) and `FieldAlignment.None` (value 3) mapping that was causing incorrect padding trimming behavior
- **ArrayPool usage in CsvStreamReader**: Buffer allocation now uses `ArrayPool<char>` for reduced memory pressure
- **Unbounded buffer growth protection**: Added 128MB absolute limit (`ABSOLUTE_MAX_BUFFER_SIZE`) for DoS protection in stream readers

## 1.0.0 - 2025-11-20
- Added configurable RFC compliance options (newlines-in-quotes opt-in, ability to disable quote parsing for speed).
- Expanded parsing helpers: culture-aware and format overloads for date/time types; enum parsing; numeric helpers across byte/short/int/long/float/decimal; timezone parsing.
- Improved UTF-8 parsing consistency and clarified allocation behavior (UTF-8 culture/format parsing decodes to UTF-16).
- Updated CI permissions for publishing test results; benchmarks now toggle RFC options for comparison.
